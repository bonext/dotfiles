#!/usr/bin/env python3
# coding: U8
import os
import socket
import re
from subprocess import run

LAYOUT_SWITCH_RE = re.compile(r"^activelayout>>(.*),\s*(Russian|English\s+\(US\))$")

SHORT_NAME = {
    "Russian": "ru",
    "English (US)": "en",
}


def register_switch_to(layout):
    run(["eww", "update", f"current_layout={layout}"])


def current_socket_name():
    return f"/tmp/hypr/{os.getenv('HYPRLAND_INSTANCE_SIGNATURE')}/.socket2.sock"


def handle(line):
    m = LAYOUT_SWITCH_RE.match(line)
    if m:
        register_switch_to(SHORT_NAME.get(m.group(2), "?"))


def main():
    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)

    try:
        sock.connect(current_socket_name())
        with sock.makefile("r") as socketfile:
            for line in socketfile:
                handle(line)

    except socket.error as err:
        print(err)
    finally:
        sock.close()


if __name__ == "__main__":
    main()
